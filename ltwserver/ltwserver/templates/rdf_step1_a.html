{% extends "base.html" %}

{% block header %}Configure LTW{% endblock %}

{% block title %}Step 1 <small>Import your RDF data</small>{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Generation the LTW configuration file from your {% if data_source == 'sparql' %}SPARQL endpoint{% else %}RDF data{% endif %}</h3>
      </div>
      <div class="panel-body">
        <div class="progress progress-striped active">
          <div class="progress-bar" style="width: 10%"></div>
        </div>
        <div class="well well-sm" id="progress-msg">
          <p class="text-success">Launching background task...</p>
        </div>
      </div>
    </div>
  </div>
</div>
<form method="POST" action="{{ url_for('rdfsource_step2') }}" id="configform">
  {{ form.csrf_token }}
  {{ form.config_file }}
</form>
{% endblock %}

{% block scripts %}
 <script type="text/javascript">
  $(document).ready(function() {
    // pole state of the current task
    var percent = 10;
    var interval = setInterval(function() { 
      $.getJSON('/_get_task_status', {task_id: "{{ task_id }}"}, 
        function(data) {
          if (data.status == 'SUCCESS' || (data.result && parseInt(data.result.progress_percent) > percent)) {
            if (data.result.progress_msg || data.status == 'SUCCESS') {
              var txt = $("#progress-msg p:last-child").text();
              $("#progress-msg p:last-child").text(txt + ' OK!');
              $("#progress-msg p:last-child").addClass("text-success");
            }
            if (data.status == 'SUCCESS') {
              clearInterval(interval);
              percent = 100;
              $("#progress-msg").append( "<p class=\"text-success\">Done!</p>" );
              $("#{{ form.config_file.id }}").val(data.result);
              $("#configform").submit();//window.location.replace("{{ url_for('rdfsource_step2') }}");
            }
            else {
              percent = parseInt(data.result.progress_percent);
              if (data.result.progress_msg)
                $("#progress-msg").append( "<p>" + data.result.progress_msg + "</p>" );
            }
            $(".progress-bar").css({'width': percent + '%'});
          }
      });
    }, 500)
  });
 </script>
{% endblock %}
