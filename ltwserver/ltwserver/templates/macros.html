{% macro with_errors(form) %}
  <div class="alert alert-dismissable alert-danger fade in">
    <button type="button" class="close" data-dismiss="alert">Ã—</button>
    <ul>
    {% for field_name, field_errors in form.errors|dictsort if field_errors %}
      {% for error in field_errors %}
        <li>{{ form[field_name].label }}: {{ error }}</li>
      {% endfor %}
    {% endfor %}
    </ul>
  </div>
{% endmacro %}

{% macro field2_10(field, field_id) %}
  <label for={{ field_id }} class="col-lg-2 control-label {% if field.errors %}text-danger{% endif %}">{{ field.label }}{% if field.flags.required %}*{% endif %}</label>
  <div class="col-lg-10 {% if field.errors %}has-error{% endif %}">
    {{ field(id=field_id, class="form-control", **kwargs) }}
  </div>
{% endmacro %}

{% macro task_status_bar(task_id, progress_msg_id, progress_bar_id, interval=500, on_success=None, on_error=None) %}
 <script type="text/javascript">
  $(document).ready(function() {
    // pole state of the current task
    var percent = 10;
    var interval = setInterval(function() {
      $.getJSON('/_get_task_status', {task_id: "{{ task_id }}"},
        function(data) {
          var last_p_txt = $("#{{ progress_msg_id }} p:last-child").text();
          if (data.status == 'FAILURE') {
            clearInterval(interval);
            $("#{{ progress_msg_id }} p:last-child").text(last_p_txt + ' ERROR!');
            $("#{{ progress_msg_id }} p:last-child").addClass("text-danger");
            $("#{{ progress_msg_id }}").append( "<p class='text-danger'>" + data.result + "</p>" );
            {% if on_error %}
              {{ on_error }}(data.result);
            {% endif %}
          }
          else if (data.status == 'SUCCESS' || (data.result && parseInt(data.result.progress_percent) > percent)) {
            if (data.status == 'SUCCESS') {
              $("#{{ progress_msg_id }} p:last-child").text(last_p_txt + ' OK!');
              $("#{{ progress_msg_id }} p:last-child").addClass("text-success");
              clearInterval(interval);
              percent = 100;
              $("#{{ progress_msg_id }}").append( "<p class=\"text-success\">Done!</p>" );
              {% if on_success %}
                {{ on_success }}(data.result);
              {% endif %}
            }
            else {
              percent = parseInt(data.result.progress_percent);
              if (data.result && data.result.progress_msg && last_p_txt != data.result.progress_msg) {
                $("#{{ progress_msg_id }} p:last-child").text(last_p_txt + ' OK!');
                $("#{{ progress_msg_id }} p:last-child").addClass("text-success");
                $("#{{ progress_msg_id }}").append( "<p>" + data.result.progress_msg + "</p>" );
              }
            }
            $("#{{ progress_bar_id }}").css({'width': percent + '%'});
          }
      });
    }, {{ interval }})
  });
 </script>
{% endmacro %}

{% macro data_tabs(data_dict) %}
  <ul class="nav nav-pills nav-stacked">
    {% for s in data_dict %}
      <!-- Nav tabs -->
      {% if data_dict[s][main] %}
        <li><a href="#datatab_{{ loop.index0|string }}" data-toggle="tab">{{ data_dict[s][main] }}</a></li>
      {% else %}
        <li><a href="#datatab_{{ loop.index0|string }}" data-toggle="tab">{{ s }}</a></li>
      {% endif %}
    {% endfor %}
  </ul>
  <div class="tab-content">
    {% for s, data in data_dict.items() %}
      <!-- Tab panes -->
      <div class="tab-pane fade {% if loop.index0 == 0 %}in active{% endif %}" id="datatab_{{ loop.index0|string }}">
        <table class="table table-condensed">
          <tbody>
            {% for triple in data.triples %}
              <tr>
                <td>{{ triple[0] }}</td>
                <td>{{ triple[1] }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  </div>
{% endmacro %}
